(function(a){a.mbl_common={defaultOptions:{debug:false,autoGetCard:true,memberInfo:{refresh:false,request:{async:true,url:"http://wxproxy-maybelline.comeyes.com:8105/api/member/mbl/",retryTime:3,beforeSend:null,isMember:null,nonMember:null,error:null,complete:null},storge:{key:"memberinfo_mbl_member",desKey:"ccegroup",setData:function(b,c){var e=new Date();e.setMinutes(e.getMinutes()+10);return a.cookie(b,c,{expires:e})},getData:function(b){return a.cookie(b)},delData:function(b){a.cookie(b,null)}}},memberCard:{signature:{async:true,url:"http://wxproxy-maybelline.comeyes.com:8105/sns/sign/card/mbl/",retryTime:3,beforeSend:null,success:null,error:null,complete:null},callbackUrl:"",cardId:"p5Ph1jpuKbyOiU0btTKcb7d4-WSo",cardOuterId:"",cardSuccessRefresh:false,cardSuccess:null,cardCancel:null,cardError:null,storge:{key:"mbl_membercard_callbackurl",desKey:"",setData:function(b,c){var e=new Date();e.setMinutes(e.getMinutes()+10);return a.cookie(b,c,{expires:e})},getData:function(b){return a.cookie(b)},delData:function(b){a.cookie(b,null)}}},memberActive:{request:{data:null,async:true,url:"/common/MemberCardServiceHandler.ashx?op=wechatapi&az=ViRDmss2Zu4pQUGQrvUh9w%3d%3d&pc=ZuqwyBLGNoUZEmpPVTM1%2fw%3d%3d",retryTime:3,beforeSend:null,successRedirect:true,success:null,error:null,complete:null},storge:{key:"mbl_membercard_callbackurl",desKey:"",setData:function(b,c){var e=new Date();e.setMinutes(e.getMinutes()+10);return a.cookie(b,c,{expires:e})},getData:function(b){return a.cookie(b)},delData:function(b){a.cookie(b,null)}}},improveMember:{request:{data:null,async:true,url:"/common/MemberCardServiceHandler.ashx?op=wechatapi&az=ViRDmss2Zu4pQUGQrvUh9w%3d%3d&pc=CL4gwYMpIYklFx3Nk6huPw%3d%3d",retryTime:3,beforeSend:null,successRedirect:true,success:null,error:null,complete:null}},smsCode:{request:{data:null,async:true,url:"/common/MemberCardServiceHandler.ashx?op=wechatapi&az=ViRDmss2Zu4pQUGQrvUh9w%3d%3d&pc=%2b%2biHZZnaONHT3462H3TDew%3d%3d",retryTime:3,beforeSend:null,success:null,error:null,complete:null},countDown:{domEl:null,durationTxt:"{%s%}s",enableTxt:"获取验证码",duration:60,disableFunc:function(){this.setAttribute("disabled","disabled")},enableFunc:function(){this.removeAttribute("disabled")}}}},CONFIG:{debug:false,member:{}},OAUTHINFO:{},MEMBERINFO:null,WECHAT:null,getOptions:function(b){return a.extend(true,a.mbl_common.CONFIG,a.mbl_common.defaultOptions,b||{})},extendOptions:function(b,d){var c=a.extend(true,{},a.mbl_common.defaultOptions[b]||{},a.mbl_common.CONFIG[b]||{},d||{});if(c.debug==undefined){c.debug=a.mbl_common.CONFIG.debug}return c},getWechat:function(b){var c={debug:b,appid:"wxe83ff6a0b1fae2ef",oauth:{wechatOauthUrl:"https://px02331.wetalk.im/connect/oauth2/authorize2",cceOauthUrl:"http://proxy.maybellinechina.com/sns/oauth2/shortcut/mbl/",redirect_uri:window.location.href,redirect_uri_query:{},validateQueryKey:"k",scope:"snsapi_base",state:"",storge:{validateKey:"wechat_oauth_validate_mbl_member",userDataKey:"wechat_oauth_user_mbl_member",desKey:"ccegroup"}},jssdk:{signature:{url:"http://wxproxy-maybelline.comeyes.com:8105/sns/sign/jssdk/mbl/",retryTime:3,autoConfig:true},jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","closeWindow","addCard","chooseCard","openCard"]},card:{signature:{url:"http://wxproxy-maybelline.comeyes.com:8105/sns/sign/card/mbl/",retryTime:3}},share:{desc:"美宝莲纽约会员俱乐部火热招募中!",title:"美宝莲纽约",link:"http://member.maybellinechina.com/member/",imgUrl:"http://member.maybellinechina.com/common/images/reg_share.png",type:"",dataUrl:"",success:function(){},cancel:function(){}}};return new a.cce.wechat(c)},memberFlow:function(c){var b=a.mbl_common.getOptions(c);var d=a.mbl_common.getWechat(b.debug);a.mbl_common.WECHAT=d;this.load=function(){var g=d.oauth();if(g){a.mbl_common.OAUTHINFO=g;a.cce.debug("Oauth Success","OauthObj",g,b.debug);b.memberInfo.debug=b.debug;var e=b.memberInfo.request.complete;b.memberInfo.request.complete=function(){d.jssdkConfig();if(typeof e=="function"){e()}};if(b.autoGetCard==true){var f=b.memberInfo.request.nonMember;b.memberInfo.request.nonMember=function(){if(wx&&wx.ready){wx.ready(function(){a.mbl_common.addMemberCard(b.memberCard)})}if(typeof f=="function"){f()}}}a.mbl_common.requestMemberInfo(g.openid,b.memberInfo)}else{a.cce.debug("Oauth Info Missed","OauthObj",g,true);d.jssdkConfig();return}}},getMemberInfo:function(){return a.extend(true,{},a.mbl_common.MEMBERINFO)},setMemberInfo:function(b){a.mbl_common.MEMBERINFO=b},requestMemberInfo:function(d,c){var b=a.mbl_common.extendOptions("memberInfo",c);var e=new a.cce.storge(b.storge);var f=e.getJSON(b.storge.key);if(f&&f.MembershipNumber&&f.MembershipNumber.length>0&&b.refresh!=true){a.cce.debug("Get Member Info","Catch From Storge",b.debug);a.mbl_common.setMemberInfo(f);if(typeof b.request.isMember=="function"){b.request.isMember(f,1)}if(typeof b.request.complete=="function"){b.request.complete()}return}a.cce.debug("Get Member Info","Begin Request",b.debug);a.cce.ajax({url:b.request.url,async:b.request.async,type:"get",dataType:"json",data:{openid:d},beforeSend:b.request.beforeSend,success:function(g){a.cce.debug("Get Member Info","Request Success",g,b.debug);if(g.Code=="10000"){a.cce.debug("Get Member Info","Response IsNumber",g,b.debug);var h=a.extend({},g.Data);h.MembershipNumber=a.mbl_common.memberValueDecrypt(h.MembershipNumber||"")||"";h.InitBonus=a.mbl_common.memberValueDecrypt(h.InitBonus||"")||"";h.UserName=unescape(a.mbl_common.memberValueDecrypt(h.UserName||"")||"");h.Birthday=a.mbl_common.memberValueDecrypt(h.Birthday||"")||"";h.HeaderImageURL=a.mbl_common.memberValueDecrypt(h.HeaderImageURL||"")||"";h.Mobile=a.mbl_common.memberValueDecrypt(h.Mobile||"")||"";h.openid=d;e.setJSON(b.storge.key,h);a.mbl_common.setMemberInfo(h);if(typeof b.request.isMember=="function"){b.request.isMember(h,0)}}else{if(g.Code=="10002"){a.cce.debug("Get Member Info","Response NonNumber",g,b.debug);e.del(b.storge.key);if(typeof b.request.nonMember=="function"){if(b.request.nonMember()==false){return false}}}else{a.cce.debug("Get Member Info","Response Error",g,b.debug);e.del(b.storge.key);if(typeof b.request.error=="function"){b.request.error(g)}}}},error:function(i,g,h){a.cce.debug("Get Member Info","Request Error",i,b.debug);e.del(b.storge.key);if(typeof b.request.error=="function"){b.request.error(i,g,h)}},complete:b.request.complete},{errRetryLimit:b.request.retryTime,errRetry:function(i,g,h,j){a.cce.debug("Get Member Info","Request Retry "+j.toString(),i,b.debug)}})},addMemberCard:function(d){var b=a.mbl_common.extendOptions("memberCard",d);var c=b.signature.success;b.signature.success=function(e){if(wx&&wx.addCard){a.cce.debug("Add Member Card","WX Add Card",b.debug);if(b.callbackUrl&&b.callbackUrl.length>0){var f=new a.cce.storge(b.storge);f.setString(b.storge.key,b.callbackUrl)}wx.addCard({cardList:[{cardId:e.card_id,cardExt:'{"code": "", "openid": "", "timestamp": "'+e.timestamp+'", "nonce_str": "'+e.nonceStr+'", "signature":"'+e.signature+'","outer_id":"'+b.cardOuterId+'"}'}],success:function(){if(b.cardSuccessRefresh==true){a.mbl_common.requestMemberInfo(a.mbl_common.OAUTHINFO.openid,{refresh:true,request:{async:true,retryTime:3,isMember:function(g){if(typeof b.cardSuccess=="function"){b.cardSuccess(g)}},nonMember:function(){if(typeof b.cardSuccess=="function"){b.cardSuccess(null)}},error:function(){if(typeof b.cardSuccess=="function"){b.cardSuccess(null)}},complete:function(){}}})}else{if(typeof b.cardSuccess=="function"){b.cardSuccess()}}},cancel:b.cardCancel,error:b.cardError})}else{a.cce.debug("Add Member Card","wx config not ready",b.debug)}if(typeof c=="function"){c(e)}};a.cce.cardSignature(b.cardId,b)},sendSMSCode:function(d){var c=a.mbl_common.extendOptions("smsCode",d);var b="";try{b=JSON.stringify(c.request.data)}catch(f){a.cce.debug("Send SMS","Data Error",f,c.debug);if(typeof c.request.error=="function"){c.request.error(f)}}a.cce.debug("Send SMS","Begin Request",c,c.debug);a.cce.ajax({url:c.request.url,async:c.request.async,type:"post",dataType:"json",data:b,beforeSend:c.request.beforeSend,success:function(g){a.cce.debug("Send SMS","Request Success",g,c.debug);if(g.Code&&g.Code=="10000"){a.cce.debug("Send SMS","Response Success",g,c.debug);if(typeof c.request.success=="function"){c.request.success(g.Data)}}else{a.cce.debug("Send SMS","Response Error",g,c.debug);var e="";switch(g.Code){case"10001":e="发生了点异常情况，返回下重新点击发送试试";break;case"10002":e="今天发送的次数有点多，明天再试下吧";break;default:e="激活的人似乎有点多，请稍后再试下";break}if(typeof c.request.error=="function"){c.request.error(e)}}},error:function(h,e,g){a.cce.debug("Send SMS","Request Error",h,c.debug);if(typeof c.request.error=="function"){c.request.error(h,e,g)}},complete:c.request.complete},{errRetryLimit:c.request.retryTime,errRetry:function(h,e,g,i){a.cce.debug("Send SMS","Request Retry "+i.toString(),h,c.debug)}})},activeMember:function(c){var b=a.mbl_common.extendOptions("memberActive",c);a.cce.debug("Active Member","Begin Request",b,b.debug);var d=function(){if(b.request.successRedirect==true){var e=new a.cce.storge(b.storge);var f=e.getString(b.storge.key);if(f&&f.length>0){e.del(b.storge.key);window.location.href=f}}};a.cce.ajax({url:b.request.url,async:b.request.async,type:"post",dataType:"json",data:JSON.stringify(b.request.data),beforeSend:b.request.beforeSend,success:function(f){if(f.Code&&f.Code=="10000"){a.cce.debug("Active Member","Response Success",f,b.debug);d();if(typeof b.request.success=="function"){b.request.success(f.Data)}}else{a.cce.debug("Active Member","Response Error",f,b.debug);var e="";switch(f.Code){case"10001":e="发生了点异常情况，返回下重新点击激活试试";break;case"10002":e="有信息填写错误哦";break;case"10003":e="验证码不对哦";break;case"10004":e="操作时间有点长，验证码已过期啦，重新获取下试试";break;case"10005":e="您已经是会员啦，清理下微信缓存试试";break;case"10006":e="激活的人似乎有点多，请稍后再试下";break;case"10007":e="发生了点异常情况，返回下重新点击激活试试";break;case"10008":e="激活的人似乎有点多，请稍后再试下";break;case"014":e="这个微信账号已绑定过啦";break;case"015":e="手机号已经绑定过啦，换一个吧";break;default:e="激活的人似乎有点多，请稍后再试下";break}if(typeof b.request.error=="function"){b.request.error(e)}}},error:function(g,e,f){a.cce.debug("Active Member","Request Error",g,b.debug);if(typeof b.request.error=="function"){b.request.error(g,e,f)}},complete:b.request.complete},{errRetryLimit:b.request.retryTime,errRetry:function(g,e,f,h){a.cce.debug("Active Member","Request Retry "+h.toString(),g,b.debug)}})},improveMember:function(c){var b=a.mbl_common.extendOptions("improveMember",c);a.cce.debug("Improve Member","Begin Request",b,b.debug);a.cce.ajax({url:b.request.url,async:b.request.async,type:"post",dataType:"json",data:JSON.stringify(b.request.data),beforeSend:b.request.beforeSend,success:function(e){if(e.Code&&e.Code=="10000"){a.cce.debug("Improve Member","Response Success",e,b.debug);if(typeof b.request.success=="function"){b.request.success(e.Data)}}else{a.cce.debug("Active Member","Response Error",e,b.debug);var d="";switch(e.Code){case"10001":d="发生了点异常情况，返回下重新点击激活试试";break;case"10002":d="有信息填写错误哦";break;case"10003":d="发生了点异常情况，返回下重新点击激活试试";break;case"10004":d="有信息填写错误哦";break;default:d="激活的人似乎有点多，请稍后再试下";break}if(typeof b.request.error=="function"){b.request.error(d)}}},error:function(f,d,e){a.cce.debug("Improve Member","Request Error",f,b.debug);if(typeof b.request.error=="function"){b.request.error(f,d,e)}},complete:b.request.complete},{errRetryLimit:b.request.retryTime,errRetry:function(f,d,e,g){a.cce.debug("Improve Member","Request Retry "+g.toString(),f,b.debug)}})},memberValueDecrypt:function(h){var g="123";if(h==null||h.length<8){return}if(g==null||g.length<=0){return}var m="";for(var d=0;d<g.length;d++){m+=g.charCodeAt(d).toString()}var j=Math.floor(m.length/5);var c=parseInt(m.charAt(j)+m.charAt(j*2)+m.charAt(j*3)+m.charAt(j*4)+m.charAt(j*5));var b=Math.round(g.length/2);var k=Math.pow(2,31)-1;var e=parseInt(h.substring(h.length-8,h.length),16);h=h.substring(0,h.length-8);m+=e;while(m.length>10){m=(parseInt(m.substring(0,10))+parseInt(m.substring(10,m.length))).toString()}m=(c*m+b)%k;var f="";var l="";for(var d=0;d<h.length;d+=2){f=parseInt(parseInt(h.substring(d,d+2),16)^Math.floor((m/k)*255));l+=String.fromCharCode(f);m=(c*m+b)%k}return l},smsCountDown:function(e){var d=e.duration*1000;var c=new Date().getTime();e.domEl.disalbeFunc=e.disableFunc;e.domEl.enableFunc=e.enableFunc;e.domEl.disalbeFunc();setTimeout(function b(){var g=d-new Date().getTime()+c;var f=parseInt(g/1000);if(f<=0){e.domEl.enableFunc();e.domEl.innerHTML=e.enableTxt;return false}else{e.domEl.innerHTML=e.durationTxt.replace("{%s%}",f);setTimeout(b,1000)}},1000)}}})(jQuery);